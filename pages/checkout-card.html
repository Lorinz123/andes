<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Card Payment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/style/checkout-card.css">
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navdiv">
      <div class="logo">
        <img src="../assets/image/logo.png" alt="Logo">
        <p>FLOWER PUFF</p>
      </div>
      <ul>
        <li><a href="../index.php">Home</a></li>
        <li><a href="shop.php">Shop</a></li>
        <li><a href="about.php">About</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="checkout-container">
    <h1 class="checkout-title text-center mt-4">CHECKOUT</h1>

    <section class="payment-section mt-5">
      <h3>Payment</h3>
      <div class="form-check mb-4">
        <input class="form-check-input" type="checkbox" checked disabled>
        <label class="form-check-label fw-bold">Card</label>
      </div>

      <div class="row g-4">
        <div class="col-md-6">
          <label for="cardNumber" class="form-label">Card number</label>
          <input type="text" class="form-control" id="cardNumber" placeholder="Enter card number">
        </div>
        <div class="col-md-6">
          <label for="cardName" class="form-label">Name on card</label>
          <input type="text" class="form-control" id="cardName" placeholder="Name on card">
        </div>
      </div>

      <div class="row g-4 mt-2">
        <div class="col-md-6">
          <label for="expiryDate" class="form-label">Expiry date</label>
          <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
        </div>
        <div class="col-md-6">
          <label for="cvv" class="form-label">CVV</label>
          <input type="text" class="form-control" id="cvv" placeholder="CVV">
        </div>
      </div>

      <div class="button-group mt-5 d-flex justify-content-between">
        <button class="btn place-order-btn" id="placeOrderBtn">Place Order</button>
        <button class="btn back-btn" id="backBtn" onclick="history.back()">Back</button>
      </div>
    </section>
  </main>

  <footer class="footer text-center mt-auto">
    <p>Copyrights 2025. Flower Puff’s Management. All Rights Reserved.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // create inline message element
  const topSection = document.querySelector('.payment-section');
  let cardMsgEl = null;
  if (topSection) {
    cardMsgEl = document.createElement('div');
    cardMsgEl.id = 'cardMessage';
    cardMsgEl.style.cssText = 'color:#b00020;font-weight:600;margin-bottom:12px;display:none;';
    topSection.insertBefore(cardMsgEl, topSection.firstChild);
  }

  function showCardMessage(text) {
    if (!cardMsgEl) return;
    cardMsgEl.textContent = text;
    cardMsgEl.style.display = 'block';
    cardMsgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => { cardMsgEl.style.display = 'none'; }, 6000);
  }

  document.getElementById("placeOrderBtn").addEventListener("click", async function(e) {
    // Check cart
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (!cart || cart.length === 0) {
      showCardMessage('Your cart is empty. Add items before placing an order.');
      return;
    }

    // Validate card fields
    const required = ['cardNumber', 'cardName', 'expiryDate', 'cvv'];
    const missing = required.filter(id => {
      const el = document.getElementById(id);
      return !el || el.value.trim() === '';
    });
    if (missing.length > 0) {
      showCardMessage('Please complete all card details before placing your order.');
      return;
    }

    // Basic CVV numeric check
    const cvv = document.getElementById('cvv').value.trim();
    if (!/^[0-9]{3,4}$/.test(cvv)) {
      showCardMessage('Please enter a valid CVV (3 or 4 digits).');
      return;
    }

    // Basic card number check (digits and length)
    const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
    if (!/^[0-9]{12,19}$/.test(cardNumber)) {
      showCardMessage('Please enter a valid card number.');
      return;
    }

    // All good — save order server-side, store response locally, clear cart and proceed to success
    try {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const subtotal = (cart || []).reduce((s, it) => s + (parseFloat(it.price) || 0) * (parseInt(it.quantity) || 0), 0);
      const order = {
        items: cart,
        subtotal: subtotal,
        customer: null,
        shipping: null,
        payment: 'Card',
        placedAt: new Date().toISOString()
      };

      const resp = await fetch('../api/save_order.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(order)
      });
      const result = await resp.json();
      if (!result || !result.success) {
        console.error('Failed to save card order:', result);
        showCardMessage('Failed to place order. Please try again.');
        return;
      }

      sessionStorage.setItem('lastOrder', JSON.stringify(result.order));
    } catch (e) { console.warn('Could not build order summary:', e); showCardMessage('Failed to place order. Please try again.'); return; }
    try { localStorage.removeItem('cart'); } catch (e) { console.warn('Could not clear cart:', e); }
    window.location.href = "success.html";
  });
</script>
</body>
</html>