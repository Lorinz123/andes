<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | Flower Puff</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/style/checkout.css">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navdiv">
      <div class="logo">
        <img src="../assets/image/logo.png" alt="Flower Puff Logo">
        <p>FLOWER PUFF</p>
      </div>
      <ul>
        <li><a href="../index.php">Home</a></li>
        <li><a href="shop.php">Shop</a></li>
        <li><a href="about.php">About</a></li>
      </ul>
    </div>
  </nav>

  <!-- Checkout Form -->
  <main class="container">
    <h1>CHECKOUT</h1>

    <form id="checkoutForm">
      <div id="checkoutMessage" style="color:#b00020;font-weight:600;margin-bottom:12px;display:none;"></div>
      <!-- Personal Information -->
      <h4>Personal Information</h4>
      <div class="row mb-3">
        <div class="col-md-6 mb-3">
          <input type="email" class="form-control" id="email" placeholder="Email Address" required>
        </div>
        <div class="col-md-6 mb-3">
          <input type="text" class="form-control" id="code" placeholder="Code" required>
        </div>
      </div>

      <!-- Shipping Information -->
      <h4>Shipping Information</h4>
      <div class="row mb-3">
        <div class="col-md-6 mb-3">
          <input type="text" class="form-control" id="firstName" placeholder="First Name" required>
        </div>
        <div class="col-md-6 mb-3">
          <input type="text" class="form-control" id="lastName" placeholder="Last Name" required>
        </div>
        <div class="col-md-4 mb-3">
          <input type="text" class="form-control" id="country" placeholder="Country" required>
        </div>
        <div class="col-md-4 mb-3">
          <input type="text" class="form-control" id="city" placeholder="City" required>
        </div>
        <div class="col-md-4 mb-3">
          <input type="text" class="form-control" id="postCode" placeholder="Post Code" required>
        </div>
        <div class="col-12 mb-3">
          <input type="text" class="form-control" id="address" placeholder="Complete Address" required>
        </div>
      </div>

      <!-- Shipping Method -->
      <h4>Shipping Method</h4>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="shippingMethod" id="standard" value="Standard Shipping" required>
        <label class="form-check-label" for="standard">Standard Shipping</label>
      </div>
      <div class="form-check mb-4">
        <input class="form-check-input" type="radio" name="shippingMethod" id="pickup" value="Pickup" required>
        <label class="form-check-label" for="pickup">Pickup</label>
      </div>

      <h4>Payment</h4>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="payment" id="cod" value="Cash on Delivery" required>
        <label class="form-check-label" for="cod">Cash on Delivery</label>
      </div>
      <div class="form-check mb-5">
        <input class="form-check-input" type="radio" name="payment" id="card" value="Card" required>
        <label class="form-check-label" for="card">Card</label>
      </div>
      <div id="paymentMessage" style="color:#b00020;font-weight:600;margin-bottom:12px;display:none;"></div>

      <div class="btn-container">
        <button type="button" class="btn btn-custom" id="placeOrderBtn">Place Order</button>
        <button type="button" class="btn btn-custom" id="backBtn">Back</button>
      </div>
    </form>
  </main>

  <footer>
    <p>Copyrights 2025. Flower Puff’s Management. All Rights Reserved.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById("placeOrderBtn").addEventListener("click", async function() {
      const msgEl = document.getElementById('checkoutMessage');
      function showMessage(text) {
        if (!msgEl) return;
        msgEl.textContent = text;
        msgEl.style.display = 'block';
        msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => { msgEl.style.display = 'none'; }, 6000);
      }

      // Validate cart and required fields before proceeding
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (!cart || cart.length === 0) {
        showMessage('Your cart is empty. Add items before placing an order.');
        return;
      }

      const requiredIds = ['email','code','firstName','lastName','country','city','postCode','address'];
      const missing = requiredIds.filter(id => {
        const el = document.getElementById(id);
        return !el || el.value.trim() === '';
      });
      if (missing.length > 0) {
        showMessage('Please complete all personal and shipping information before placing your order.');
        return;
      }

      const shippingSelected = document.querySelector('input[name="shippingMethod"]:checked');
      if (!shippingSelected) {
        showMessage('Please select a shipping method.');
        return;
      }

      const paymentSelected = document.querySelector('input[name="payment"]:checked');
      if (!paymentSelected) {
        showMessage('Please select a payment method.');
        return;
      }

      // All checks passed — save order summary to sessionStorage, clear cart and proceed to success page
      try {
        const subtotal = (cart || []).reduce((s, it) => s + (parseFloat(it.price) || 0) * (parseInt(it.quantity) || 0), 0);
        const order = {
          items: cart,
          subtotal: subtotal,
          customer: {
            email: document.getElementById('email').value.trim(),
            code: document.getElementById('code').value.trim(),
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            address: document.getElementById('address').value.trim(),
            country: document.getElementById('country').value.trim(),
            city: document.getElementById('city').value.trim(),
            postCode: document.getElementById('postCode').value.trim()
          },
          shipping: document.querySelector('input[name="shippingMethod"]:checked')?.value || null,
          payment: document.querySelector('input[name="payment"]:checked')?.value || null,
          placedAt: new Date().toISOString()
        };

        // POST to server to persist order
        const resp = await fetch('../api/save_order.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });
        const result = await resp.json();
        if (!result || !result.success) {
          console.error('Failed to save order:', result);
          showMessage('Failed to place order. Please try again.');
          return;
        }

        // store server response for success page and clear cart
        sessionStorage.setItem('lastOrder', JSON.stringify(result.order));
        try { localStorage.removeItem('cart'); } catch (e) { console.warn('Could not clear cart:', e); }
        window.location.href = "success.html";

      } catch (e) {
        console.warn('Could not build order summary:', e);
        showMessage('Failed to place order. Please try again.');
      }
    });

    document.getElementById("backBtn").addEventListener("click", function() {
      window.location.href = "shop.php";
    });

    document.addEventListener("DOMContentLoaded", function() {
      const cardOption = document.getElementById("card");
      const paymentMsg = document.getElementById('paymentMessage');

      function showPaymentMessage(text) {
        if (!paymentMsg) return;
        paymentMsg.textContent = text;
        paymentMsg.style.display = 'block';
        paymentMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => { paymentMsg.style.display = 'none'; }, 6000);
      }

      cardOption.addEventListener("change", function() {
        if (cardOption.checked) {
          const requiredIds = ['firstName','lastName','email','address','country','city','code','postCode'];
          const missing = requiredIds.map(id => document.getElementById(id))
                                     .find(el => !el || el.value.trim() === '');

          if (missing) {
            showPaymentMessage('⚠️ Please complete all personal and shipping information before selecting Card payment.');
            // focus the first missing field if available
            if (missing && typeof missing.focus === 'function') missing.focus();
            cardOption.checked = false;
          } else {
            window.location.href = "checkout-card.html";
          }
        }
      });
    });
  </script>
</body>
</html>
